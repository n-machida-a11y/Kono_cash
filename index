<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>現金経費精算アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; }
    .navbar { background-color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; color: white !important; display: flex; align-items: center; gap: 10px; }
    .nav-link { color: rgba(255,255,255,0.85) !important; font-weight: 500; }
    .nav-link.active { color: white !important; font-weight: bold; background-color: rgba(255,255,255,0.2); border-radius: 4px; }
    .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; transition: transform 0.2s; }
    .selection-card { cursor: pointer; border: 1px solid #dee2e6; height: 100%; }
    .selection-card:hover { transform: translateY(-3px); border-color: #0d6efd; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .modal-fullscreen .modal-body { overflow-y: hidden; position: relative; }
    .modal-title-custom { font-size: 1.15rem; font-weight: bold; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .preview-container { height: 100vh; background: #333; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
    .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .detail-card { background-color: #fff; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin-top: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; }
    .amount-input-style { font-weight: bold; color: #0d6efd; font-size: 1.1rem !important; }
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 10060; display: none; justify-content: center; align-items: center; flex-direction: column; }
    
    .btn-edit-unify { font-size: 0.75rem; padding: 2px 8px; white-space: nowrap; }

    /* ========== モード制御用クラス ========== */
    .row.manual-mode .pane-preview { display: none !important; }
    .row.manual-mode .pane-form { width: 100% !important; flex: 0 0 100% !important; max-width: 100% !important; }

    @media (min-width: 992px) { .mobile-tab-nav { display: none !important; } .pane-preview, .pane-form { display: flex !important; } }
    @media (max-width: 991.98px) { 
      .pane-preview, .pane-form { width: 100% !important; height: calc(100vh - 50px) !important; display: none; } 
      .pane-preview.active-pane, .pane-form.active-pane { display: flex !important; } 
      .row.manual-mode .pane-form { display: flex !important; height: 100vh !important; } 
      .mobile-tab-nav { position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background: white; border-top: 1px solid #ddd; display: flex; z-index: 1050; } 
      .mobile-tab-btn { flex: 1; border: none; background: transparent; font-weight: bold; color: #6c757d; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; } 
      .mobile-tab-btn.active { color: #0d6efd; background-color: #e7f1ff; border-top: 3px solid #0d6efd; } 
    }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
  <div class="mt-3 fs-5 fw-bold text-secondary" id="loadingText">処理中...</div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 sticky-top">
  <div class="container-xl">
    <a class="navbar-brand" href="#"><i class="fas fa-coins me-2"></i>現金経費精算アプリ</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" id="nav-apply" href="#" onclick="showView('apply'); resetApplyForm();">新規登録</a></li>
        <li class="nav-item"><a class="nav-link" id="nav-dashboard" href="#" onclick="showView('dashboard')">ダッシュボード</a></li>
        <li class="nav-item" id="navApproval" style="display:none;"><a class="nav-link" id="nav-approvalList" href="#" onclick="showView('approvalList')">承認タスク <span class="badge bg-danger" id="badgeCount">0</span></a></li>
        <li class="nav-item" id="navAdmin" style="display:none;"><a class="nav-link" id="nav-admin" href="#" onclick="showView('admin')">管理・出力</a></li>
      </ul>
      <span class="navbar-text text-white" id="userInfo"></span>
    </div>
  </div>
</nav>

<div class="container-xl pb-5">
  <!-- View: Dashboard -->
  <div id="dashboardView" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>ダッシュボード</h3>
      <button class="btn btn-outline-secondary btn-sm" onclick="loadDashboard()"><i class="fas fa-sync-alt"></i> 更新</button>
    </div>
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item"><button class="nav-link active" id="my-tab" data-bs-toggle="tab" data-bs-target="#my-tab-pane" type="button">マイ申請履歴</button></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="my-tab-pane">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
             <div class="alert alert-light border small mb-0 py-2"><i class="fas fa-info-circle me-1"></i> [未申請]を選択してまとめて申請できます。</div>
             <button class="btn btn-success btn-sm" id="btnBulkSubmit" onclick="submitBulk()" disabled><i class="fas fa-paper-plane me-2"></i>一括申請</button>
          </div>
          <table class="table table-hover align-middle">
            <thead><tr><th width="100">修正・確認</th><th width="40"><input type="checkbox" onclick="toggleAll(this, '.history-check')"></th><th>利用日</th><th>支払先</th><th>金額</th><th>状態</th><th>承認者</th></tr></thead>
            <tbody id="myAppList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- View: Apply -->
  <div id="applyView" style="display:none;">
    <h3 class="mb-4">経費データ登録</h3>
    <div class="container" style="max-width: 900px;">
      <p class="mb-4 text-muted">登録方法を選択</p>
      <input type="file" id="fileInputUnified" hidden accept="image/*" multiple onchange="handleFiles(this.files)">
      <div class="row g-4 justify-content-center">
        <div class="col-md-5">
          <div class="card selection-card h-100 p-4 text-center" onclick="document.getElementById('fileInputUnified').click()">
            <div class="card-body d-flex flex-column align-items-center">
              <div class="mb-3 text-primary"><i class="fas fa-camera fa-4x"></i></div>
              <h4 class="fw-bold mb-2">領収書を読み込む</h4>
              <p class="text-muted mb-0 small">AIが内容を自動入力します</p>
            </div>
          </div>
        </div>
        <div class="col-md-5">
          <div class="card selection-card h-100 p-4 text-center" onclick="startManualEntry()">
            <div class="card-body d-flex flex-column align-items-center">
              <div class="mb-3 text-success"><i class="fas fa-keyboard fa-4x"></i></div>
              <h4 class="fw-bold mb-2">手入力で作成</h4>
              <p class="text-muted mb-0 small">領収書がない経費など</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View: Admin -->
  <div id="adminView" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>④ 管理者画面</h4>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success fw-bold" onclick="processAdminAction('checkBulk')">選択を確認済みにする</button>
            <button class="btn btn-primary fw-bold" onclick="downloadCSV('kanjo')">CSV出力して完了</button>
        </div>
    </div>
    
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body p-3">
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">対象月</label>
                    <input type="month" id="adminFilterMonth" class="form-control form-control-sm" onchange="renderAdminTable()">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">絞り込み</label>
                    <input type="text" id="adminFilterSearch" class="form-control form-control-sm" placeholder="店名・名前..." oninput="renderAdminTable()">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">表示ステータス</label>
                    <select id="adminFilterStatus" class="form-select form-select-sm" onchange="renderAdminTable()">
                        <option value="all">すべて</option>
                        <option value="承認済" selected>経理未チェック (承認済)</option>
                        <option value="確認済み">経理チェック済 (CSV待)</option>
                    </select>
                </div>
                <div class="col-md-3 text-end pt-4">
                    <span class="badge bg-light text-dark border shadow-sm"><span id="adminDisplayCount">0</span>件表示中</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-0 shadow-sm overflow-hidden">
        <div class="table-responsive" style="max-height: 60vh;">
            <table class="table table-hover align-middle mb-0">
                <thead class="sticky-top bg-light">
                    <tr>
                        <th width="100">修正・確認</th>
                        <th width="40"><input type="checkbox" onclick="toggleAll(this, '.admin-check')"></th>
                        <th style="cursor:pointer" onclick="sortAdminData('useDate')">利用日 <i class="fas fa-sort small opacity-50"></i></th>
                        <th>申請者</th>
                        <th>支払先</th>
                        <th>科目</th>
                        <th class="text-end" style="cursor:pointer" onclick="sortAdminData('amount')">金額 <i class="fas fa-sort small opacity-50"></i></th>
                        <th class="text-center">状態</th>
                    </tr>
                </thead>
                <tbody id="adminBody"></tbody>
            </table>
        </div>
    </div>
  </div>
  
  <!-- View: Approval -->
  <div id="approvalListView" style="display:none;">
    <h3 class="mb-4">承認待ち案件</h3>
    <div class="card p-3 overflow-hidden shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th width="100">修正・確認</th>
              <th>申請者</th>
              <th>利用日</th>
              <th>支払先</th>
              <th class="text-end">金額</th>
              <th width="100">操作</th>
            </tr>
          </thead>
          <tbody id="approvalListContainer"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Edit -->
<div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-body p-0 h-100">
        <input type="hidden" id="editId">
        <div class="row g-0 h-100" id="modalRow">
          <div class="col-lg-6 bg-dark preview-container pane-preview" id="panePreview">
            <div id="imagePreviewArea" class="w-100 h-100 d-flex justify-content-center align-items-center">
                <img id="previewImg" class="preview-img" src="" alt="プレビュー">
                <div id="noPreview" class="text-white text-center" style="display:none;"><i class="fas fa-eye-slash fa-3x mb-3"></i><br>画像なし</div>
            </div>
            <div class="position-absolute bottom-0 start-0 p-3 w-100 text-white" style="background: rgba(0,0,0,0.5);">
               <div class="form-check"><input class="form-check-input" type="checkbox" id="checkInvoice"><label class="form-check-label" for="checkInvoice">インボイス登録番号あり</label></div>
               <div class="mt-2"><label class="btn btn-sm btn-outline-light">画像差替<input type="file" id="editFileInput" hidden accept="image/*"></label></div>
            </div>
          </div>
          <div class="col-lg-6 h-100 pane-form active-pane d-flex flex-column">
            <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center shadow-sm">
              <h5 class="modal-title-custom m-0" id="modalTitle">登録内容の修正</h5>
              <div id="modalActions"></div>
            </div>
            <div class="p-4" style="overflow-y: auto; flex-grow: 1;">
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-body row g-3">
                    <div class="col-md-6"><label class="form-label">申請者</label><input type="text" class="form-control" id="formUserName" list="userList" onchange="checkAllowanceAmount()"></div>
                    <div class="col-md-6"><label class="form-label">利用日</label><input type="date" class="form-control" id="formDate"></div>
                    <div class="col-12"><div class="form-check form-switch bg-light p-2 rounded border"><input class="form-check-input ms-0 me-2" type="checkbox" id="checkIsAllowance" onchange="checkAllowanceAmount()"><label class="form-check-label fw-bold" for="checkIsAllowance">日当を申請する</label></div></div>
                    <div class="col-12" id="storeNameRow"><label class="form-label">支払先</label><input type="text" class="form-control" id="formStore"></div>
                    <div class="col-12"><label class="form-label text-primary">合計金額 (税込)</label><input type="number" class="form-control text-end amount-input-style" id="formTotalAmount"></div>
                </div>
              </div>
              <div id="detailItemsContainer"></div>
              <button class="btn btn-sm btn-outline-success w-100 mt-2" onclick="addDetailItem()">+ 明細追加</button>
            </div>
          </div>
        </div>
        <div class="mobile-tab-nav" id="mobileTabNav">
          <button class="mobile-tab-btn" id="tabBtnPreview" onclick="switchMobileTab('preview')"><i class="fas fa-image"></i> 画像</button>
          <button class="mobile-tab-btn active" id="tabBtnForm" onclick="switchMobileTab('form')"><i class="fas fa-edit"></i> フォーム</button>
        </div>
      </div>
    </div>
  </div>
</div>

<datalist id="categoryList"></datalist>
<datalist id="userList"></datalist>
<datalist id="itemNameList"><option value="日当"><option value="宿泊"><option value="燃料代"><option value="公共交通機関"></datalist>

<script>
  let currentUser = null, historyData = [], detailData = [], editModal = null, pendingDrafts = [], currentDraftIndex = -1, adminSortKey = 'useDate', adminSortOrder = 1, userMasters = [];

  window.onload = function() {
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
    document.getElementById('adminFilterMonth').value = new Date().toISOString().slice(0,7);
    loadUser();
  };

  function switchMobileTab(target) {
    const p = document.getElementById('panePreview'), f = document.querySelector('.pane-form');
    if (target === 'preview') { p.classList.add('active-pane'); f.classList.remove('active-pane'); }
    else { p.classList.remove('active-pane'); f.classList.add('active-pane'); }
  }

  function loadUser() {
    showLoading(true);
    google.script.run.withSuccessHandler(user => {
      currentUser = user;
      document.getElementById('userInfo').textContent = `${user.name} (${user.role})`;
      if (['経理','管理者','社長'].includes(user.role)) {
          document.getElementById('navApproval').style.display = 'block';
          document.getElementById('navAdmin').style.display = 'block';
      }
      loadMasters(); loadDashboard(); showView('apply'); showLoading(false);
    }).getCurrentUser();
  }

  function showView(v) {
    ['dashboardView','applyView','approvalListView','adminView'].forEach(id => document.getElementById(id).style.display = 'none');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if(document.getElementById('nav-'+v)) document.getElementById('nav-'+v).classList.add('active');
    document.getElementById(v + 'View').style.display = 'block';
    if(v === 'admin') loadAdminData();
    if(v === 'dashboard') loadDashboard();
    if(v === 'approvalList') loadDashboard();
  }

  function loadMasters() {
    google.script.run.withSuccessHandler(d => {
      userMasters = d.users;
      document.getElementById('categoryList').innerHTML = d.accounts.map(a => `<option value="${a}">`).join('');
      document.getElementById('userList').innerHTML = d.users.map(u => `<option value="${u.name}">`).join('');
    }).getMasters();
  }

  function renderAdminTable() {
    const tbody = document.getElementById('adminBody');
    const month = document.getElementById('adminFilterMonth').value;
    const search = document.getElementById('adminFilterSearch').value.toLowerCase();
    const statusFilter = document.getElementById('adminFilterStatus').value;
    
    let filtered = historyData.filter(r => {
        const matchMonth = !month || (r.useDate && r.useDate.startsWith(month.replace('-','/')));
        const matchSearch = !search || r.store.toLowerCase().includes(search) || r.user.toLowerCase().includes(search);
        const matchStatus = statusFilter === 'all' || r.status === statusFilter;
        return matchMonth && matchSearch && matchStatus;
    });

    filtered.sort((a,b) => {
        let valA = a[adminSortKey], valB = b[adminSortKey];
        if(adminSortKey === 'amount') { valA = Number(valA); valB = Number(valB); }
        return valA < valB ? -adminSortOrder : valA > valB ? adminSortOrder : 0;
    });

    tbody.innerHTML = filtered.map(r => `
        <tr style="cursor:pointer" onclick="fetchAndOpenDraft('${r.id}', true)">
            <td><button class="btn btn-sm btn-outline-primary btn-edit-unify py-0"><i class="fas fa-edit me-1"></i>修正・確認</button></td>
            <td onclick="event.stopPropagation()"><input type="checkbox" class="admin-check" value="${r.id}"></td>
            <td>${r.useDate}</td><td>${r.user}</td><td><b>${r.store}</b></td><td><small>${r.category}</small></td>
            <td class="text-end fw-bold">¥${Number(r.amount).toLocaleString()}</td>
            <td class="text-center"><span class="badge ${r.status==='確認済み'?'bg-info':'bg-warning text-dark'}">${r.status}</span></td>
        </tr>`).join('') || '<tr><td colspan="8" class="text-center py-4">なし</td></tr>';
    document.getElementById('adminDisplayCount').textContent = filtered.length;
  }

  function sortAdminData(k) { if(adminSortKey === k) adminSortOrder *= -1; else { adminSortKey = k; adminSortOrder = 1; } renderAdminTable(); }
  function loadAdminData() { google.script.run.withSuccessHandler(d => { historyData = d.allApplications; renderAdminTable(); }).getDashboardData(currentUser.email); }
  function toggleAll(src, sel) { document.querySelectorAll(sel).forEach(c => c.checked = src.checked); }

  function processAdminAction(func) {
    const ids = Array.from(document.querySelectorAll('.admin-check:checked')).map(c => c.value);
    if(!ids.length) return alert('項目を選択してください');
    showLoading(true);
    google.script.run.withSuccessHandler(() => { showLoading(false); loadAdminData(); })[func](ids);
  }

  function downloadCSV() {
    const ids = Array.from(document.querySelectorAll('.admin-check:checked')).map(c => c.value);
    if(!ids.length) return alert('出力する項目を選択してください');
    showLoading(true, 'CSV作成中...');
    google.script.run.withSuccessHandler(data => {
      if(!data || data.length <= 1) return alert('有効なデータがありません');
      const csv = data.map(row => row.map(cell => {
        let s = String(cell || "");
        if (s.includes(',') || s.includes('\n') || s.includes('"')) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }).join(',')).join('\n');
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `kanjo_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      if(confirm('CSV出力を完了しました。ステータスを「CSV出力済み」に更新しますか？')) {
        google.script.run.withSuccessHandler(() => loadAdminData()).markAsExported(ids);
      }
      showLoading(false);
    }).getDataForCSV(ids);
  }

  function fetchAndOpenDraft(id, edit) {
    showLoading(true);
    google.script.run.withSuccessHandler(d => { showLoading(false); openEditWithData(d, edit); }).getApplicationDetail(id);
  }

  function openEditWithData(data, edit) {
    document.getElementById('editId').value = data.id;
    const isManual = !data.fileBase64;
    document.getElementById('modalRow').className = isManual ? 'row g-0 h-100 manual-mode' : 'row g-0 h-100';
    document.getElementById('mobileTabNav').style.display = isManual ? 'none' : 'flex';
    
    const img = document.getElementById('previewImg'), no = document.getElementById('noPreview');
    if (data.fileBase64) { img.src = `data:${data.mimeType};base64,${data.fileBase64}`; img.style.display = 'block'; no.style.display = 'none'; }
    else { img.style.display = 'none'; no.style.display = 'block'; }

    document.getElementById('formDate').value = data.useDate;
    document.getElementById('formUserName').value = data.userName;
    document.getElementById('formStore').value = data.storeName;
    document.getElementById('formTotalAmount').value = data.totalAmount;
    detailData = data.items;
    
    document.getElementById('modalActions').innerHTML = `<button class="btn btn-sm btn-outline-secondary me-2" data-bs-dismiss="modal">キャンセル</button><button class="btn btn-primary btn-sm px-3 shadow-sm fw-bold" onclick="saveEdit()">保存</button>`;
    renderDetailItems();
    editModal.show();
  }

  function renderDetailItems() {
    document.getElementById('detailItemsContainer').innerHTML = detailData.map((item, i) => `
        <div class="detail-card mb-3">
          <div class="row g-2">
            <div class="col-6"><label class="form-label">項目名</label><input type="text" class="form-control form-control-sm" list="itemNameList" value="${item.itemName}" onchange="detailData[${i}].itemName=this.value; checkAllowanceAmount()"></div>
            <div class="col-6"><label class="form-label">科目</label><input type="text" class="form-control form-control-sm" list="categoryList" value="${item.category}" onchange="detailData[${i}].category=this.value"></div>
            <div class="col-4"><label class="form-label">金額</label><input type="number" class="form-control form-control-sm text-end" value="${item.total_price}" oninput="detailData[${i}].total_price=this.value; calcHeaderTotal()"></div>
            <div class="col-8"><label class="form-label">明細メモ</label><input type="text" class="form-control form-control-sm" value="${item.memo||''}" oninput="detailData[${i}].memo=this.value"></div>
          </div>
        </div>`).join('');
    calcHeaderTotal();
  }

  function checkAllowanceAmount() {
    const isAllow = document.getElementById('checkIsAllowance').checked;
    const user = userMasters.find(u => u.name === document.getElementById('formUserName').value);
    if (isAllow) {
        document.getElementById('storeNameRow').classList.add('d-none');
        detailData[0].itemName = '日当';
        detailData[0].category = '旅費交通費';
        detailData[0].total_price = (user && user.position === '役員') ? 3000 : 2000;
        renderDetailItems();
    } else {
        document.getElementById('storeNameRow').classList.remove('d-none');
    }
  }

  function calcHeaderTotal() { let sum = 0; detailData.forEach(d => sum += Number(d.total_price)||0); document.getElementById('formTotalAmount').value = sum; }
  function addDetailItem() { detailData.push({category:'', itemName:'', total_price:0, memo:''}); renderDetailItems(); }
  function saveEdit() {
    showLoading(true);
    const payload = { id: document.getElementById('editId').value, useDate: document.getElementById('formDate').value, userName: document.getElementById('formUserName').value, storeName: document.getElementById('formStore').value, totalAmount: document.getElementById('formTotalAmount').value, items: detailData };
    google.script.run.withSuccessHandler(() => { editModal.hide(); loadDashboard(); showLoading(false); }).updateApplication(payload);
  }
  
  function loadDashboard() { google.script.run.withSuccessHandler(d => {
    // ダッシュボード更新（ボタンを左端へ）
    document.getElementById('myAppList').innerHTML = d.myApplications.map(app => `<tr>
        <td><button class="btn btn-sm btn-outline-primary btn-edit-unify" onclick="fetchAndOpenDraft('${app.id}', true)"><i class="fas fa-edit me-1"></i>修正・確認</button></td>
        <td>${app.canSubmit?`<input type="checkbox" class="history-check" value="${app.id}">`:''}</td>
        <td>${app.useDate}</td><td>${app.store}</td><td>¥${Number(app.amount).toLocaleString()}</td>
        <td><span class="badge bg-secondary">${app.status}</span></td><td>${app.approver}</td>
    </tr>`).join('');

    // 承認タスク更新（テーブル形式でボタンを左端へ）
    document.getElementById('badgeCount').textContent = d.approvalTasks.length;
    document.getElementById('approvalListContainer').innerHTML = d.approvalTasks.map(app => `
      <tr>
        <td><button class="btn btn-sm btn-outline-primary btn-edit-unify" onclick="fetchAndOpenDraft('${app.id}', false)"><i class="fas fa-search me-1"></i>修正・確認</button></td>
        <td><b>${app.user}</b></td><td>${app.useDate}</td><td>${app.store}</td>
        <td class="text-end fw-bold">¥${Number(app.amount).toLocaleString()}</td>
        <td><button class="btn btn-sm btn-primary w-100" onclick="google.script.run.withSuccessHandler(loadDashboard).approveApplication('${app.id}')">承認</button></td>
      </tr>`).join('') || '<tr><td colspan="6" class="text-center py-3 text-muted">なし</td></tr>';

  }).getDashboardData(currentUser.email); }

  function showLoading(s, t='処理中...') { document.getElementById('loadingOverlay').style.display = s?'flex':'none'; document.getElementById('loadingText').textContent = t; }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>現金経費精算</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
    .status-badge { font-size: 0.9em; }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8); z-index: 9999; display: none;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .drag-area {
      border: 2px dashed #ccc; padding: 30px; text-align: center; cursor: pointer; background: #fff;
      transition: all 0.3s;
    }
    .drag-area:hover { background-color: #f1f1f1; border-color: #0d6efd; }
    /* 明細テーブル用 */
    .detail-row input, .detail-row select { font-size: 0.9rem; }
  </style>
</head>
<body>

<!-- ローディング -->
<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
  <div class="mt-3 fs-5" id="loadingText">処理中...</div>
</div>

<!-- ナビゲーション -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fas fa-receipt me-2"></i>現金経費精算</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" id="nav-apply" href="#" onclick="showView('apply'); resetApplyForm();">新規申請</a></li>
        <li class="nav-item"><a class="nav-link" id="nav-dashboard" href="#" onclick="showView('dashboard')">ダッシュボード</a></li>
        <li class="nav-item" id="navApproval" style="display:none;"><a class="nav-link" id="nav-approvalList" href="#" onclick="showView('approvalList')">承認タスク <span class="badge bg-danger" id="badgeCount">0</span></a></li>
        <li class="nav-item" id="navAdmin" style="display:none;"><a class="nav-link" id="nav-admin" href="#" onclick="showView('admin')">管理・出力</a></li>
      </ul>
      <span class="navbar-text text-white" id="userInfo"></span>
    </div>
  </div>
</nav>

<div class="container">
  
  <div id="unregisteredView" style="display:none;">
    <div class="card p-5 mx-auto text-center" style="max-width: 600px;">
      <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
      <h3>利用権限がありません</h3>
      <p class="mt-3">アカウントが登録されていません。<br>管理者に連絡してください。</p>
      <div class="mt-3 text-muted" id="unregisteredEmail"></div>
    </div>
  </div>

  <div id="loginView" style="display:none;">
    <div class="card p-4 mx-auto" style="max-width: 400px;">
      <h4 class="text-center mb-3">ログイン</h4>
      <div class="mb-3">
        <label>メールアドレス</label>
        <input type="email" id="inputEmail" class="form-control" placeholder="user@example.com">
      </div>
      <button class="btn btn-primary w-100" onclick="manualLogin()">ログイン</button>
    </div>
  </div>

  <div id="dashboardView" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>ダッシュボード</h3>
      <button class="btn btn-outline-secondary btn-sm" onclick="loadDashboard()"><i class="fas fa-sync-alt"></i> 更新</button>
    </div>

    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="my-tab" data-bs-toggle="tab" data-bs-target="#my-tab-pane" type="button" role="tab">マイ申請履歴</button>
      </li>
      <li class="nav-item" role="presentation" id="all-tab-li" style="display:none;">
        <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-tab-pane" type="button" role="tab">全申請履歴 (経理専用)</button>
      </li>
    </ul>

    <div class="tab-content" id="dashboardTabContent">
      <div class="tab-pane fade show active" id="my-tab-pane" role="tabpanel">
        <div class="card p-3">
          <table class="table table-hover">
            <thead><tr><th>利用日</th><th>支払先</th><th>合計金額</th><th>ステータス</th><th>承認者</th><th>操作</th></tr></thead>
            <tbody id="myAppList"></tbody>
          </table>
        </div>
      </div>
      
      <div class="tab-pane fade" id="all-tab-pane" role="tabpanel">
        <div class="card p-3">
            <div class="alert alert-info py-2 small"><i class="fas fa-info-circle me-2"></i>経理権限ユーザーのみ全件表示されています</div>
            <table class="table table-hover table-sm">
            <thead><tr><th>申請者</th><th>利用日</th><th>支払先</th><th>合計金額</th><th>ステータス</th><th>承認者</th><th>操作</th></tr></thead>
            <tbody id="allAppList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="applyView">
    <h3 class="mb-4" id="applyViewTitle">経費申請</h3>
    <div class="card p-4" id="uploadArea">
      <h5 class="mb-4">申請方法を選択</h5>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="drag-area h-100" id="dropZone">
            <i class="fas fa-camera fa-3x mb-3 text-primary"></i>
            <h5>領収書を読み込む</h5>
            <p class="text-muted small">AIが内容を自動入力します</p>
            <input type="file" id="fileInput" hidden accept="image/*">
          </div>
        </div>
        <div class="col-md-6">
          <div class="drag-area h-100" onclick="startManualEntry()">
            <i class="fas fa-keyboard fa-3x mb-3 text-success"></i>
            <h5>手入力で作成</h5>
            <p class="text-muted small">領収書がない経費など</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card p-4" id="formArea" style="display:none;">
      <h5 class="mb-3">申請内容入力</h5>
      <div class="row">
        <!-- 左側：画像プレビュー -->
        <div class="col-md-3">
          <div id="previewContainer">
            <img id="previewImg" src="" class="img-fluid border rounded mb-3">
            <div class="form-check mb-3">
               <input class="form-check-input" type="checkbox" id="checkInvoice">
               <label class="form-check-label" for="checkInvoice">インボイス登録番号あり</label>
            </div>
          </div>
          <div id="noImageMessage" class="alert alert-secondary text-center" style="display:none;">
            <i class="fas fa-receipt me-2"></i>領収書画像なし<br>(手入力モード)
          </div>
          <div class="mt-2" id="editImageUpload" style="display:none;">
             <label class="form-label small">画像を差し替える場合:</label>
             <input type="file" class="form-control form-control-sm" id="editFileInput" accept="image/*">
          </div>
        </div>

        <!-- 右側：入力フォーム -->
        <div class="col-md-9">
          <!-- ヘッダー情報 -->
          <div class="row g-3 mb-4 border-bottom pb-4">
            <div class="col-12">
              <label class="form-label">申請区分 <span class="badge bg-danger">必須</span></label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="appType" id="typeBusiness" value="営業" autocomplete="off">
                <label class="btn btn-outline-primary" for="typeBusiness"><i class="fas fa-building me-2"></i>営業（小口）</label>
                <input type="radio" class="btn-check" name="appType" id="typePersonal" value="個人" autocomplete="off">
                <label class="btn btn-outline-primary" for="typePersonal"><i class="fas fa-user me-2"></i>個人（立替）</label>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">利用日 <span class="badge bg-danger">必須</span></label>
              <input type="date" class="form-control" id="formDate">
            </div>
            <div class="col-md-6">
              <label class="form-label">支払先 <span class="badge bg-danger">必須</span></label>
              <input type="text" class="form-control" id="formStore">
            </div>
            
            <div class="col-md-6">
               <label class="form-label fw-bold">領収書合計金額 (税込) <span class="badge bg-danger">必須</span></label>
               <input type="number" class="form-control bg-light" id="formTotalAmount" placeholder="領収書の合計金額">
            </div>
            <div class="col-md-6 d-flex align-items-end">
               <span id="amountAlert" class="text-danger small ms-2" style="display:none;">
                 <i class="fas fa-exclamation-circle"></i> 明細計と一致しません
               </span>
            </div>
          </div>

          <!-- 明細テーブル -->
          <div class="mb-3">
             <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold"><i class="fas fa-list me-2"></i>明細入力</h6>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="addDetailRow()"><i class="fas fa-plus"></i> 行追加</button>
             </div>
             <div class="table-responsive">
               <table class="table table-bordered table-sm" id="detailsTable">
                 <thead class="table-light">
                   <tr>
                     <th width="20%">勘定科目</th>
                     <th width="25%">項目名</th>
                     <th width="15%">金額(税込)</th>
                     <th width="15%">取引先</th>
                     <th width="10%">人数</th>
                     <th width="10%">日当</th>
                     <th width="5%"></th>
                   </tr>
                 </thead>
                 <tbody id="detailsBody">
                    <!-- JSで動的に追加 -->
                 </tbody>
                 <tfoot>
                    <tr>
                       <td colspan="2" class="text-end fw-bold">明細合計:</td>
                       <td colspan="5"><span id="calcTotal" class="fw-bold">0</span> 円</td>
                    </tr>
                 </tfoot>
               </table>
             </div>
          </div>

          <div class="col-12">
            <label class="form-label">メモ (AI読取内容)</label>
            <textarea class="form-control" id="formMemo" rows="3"></textarea>
          </div>

          <div class="mt-4 d-flex justify-content-end align-items-center">
            <button class="btn btn-outline-danger me-auto" id="btnDelete" style="display:none;" onclick="deleteCurrentApp()"><i class="fas fa-trash-alt me-2"></i>削除</button>
            <button class="btn btn-secondary me-2" onclick="showView('apply'); resetApplyForm();">キャンセル</button>
            <button class="btn btn-success" id="btnSubmit" onclick="submitApplication()"><i class="fas fa-paper-plane me-2"></i>申請する</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="approvalListView" style="display:none;">
    <h3 class="mb-4">承認待ち案件</h3>
    <div class="card p-3">
      <table class="table table-hover">
        <thead><tr><th>申請者</th><th>利用日</th><th>支払先</th><th>合計金額</th><th>操作</th></tr></thead>
        <tbody id="approvalListBody"></tbody>
      </table>
    </div>
  </div>

  <div id="adminView" style="display:none;">
    <h3 class="mb-4">経理管理メニュー</h3>
    <div class="row">
      <div class="col-md-6">
        <div class="card p-4 h-100">
          <h5><i class="fas fa-file-csv me-2"></i>データ出力</h5>
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="downloadCSV('勘定奉行')">勘定奉行用CSV</button>
            <button class="btn btn-outline-success" onclick="downloadCSV('銀行振込')">銀行振込用CSV</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4 h-100">
          <h5><i class="fas fa-cog me-2"></i>マスタ管理</h5>
          <a href="#" id="spreadsheetLink" target="_blank" class="btn btn-link">スプレッドシートを開く</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 隠しDatalist: JSでマスタから動的生成 -->
<datalist id="categoryList"></datalist>
<datalist id="itemSuggestionList"></datalist>

<script>
  // ==============================================
  // MOCK for Preview Environment (GAS Emulation)
  // ==============================================
  if (typeof google === 'undefined') {
    const mockRunner = {
      withSuccessHandler: function(cb) { const clone = Object.create(this); clone._success = cb; return clone; },
      withFailureHandler: function(cb) { const clone = Object.create(this); clone._failure = cb; return clone; },
      
      getCurrentUser: function(email) { 
        setTimeout(() => this._success && this._success({
          name: 'MockUser', email: 'test@example.com', role: '経理', canFix: true
        }), 500); 
      },
      
      getDashboardData: function() { 
        setTimeout(() => this._success && this._success({
          user:{name:'MockUser', role:'経理', canFix:true}, 
          myApplications:[
            {id:'100', useDate:'2025/01/01', store:'TestStore', amount:1000, status:'承認待ち', approver:'経理', canEdit: true},
            {id:'101', useDate:'2025/01/05', store:'Store X', amount:5000, status:'差戻し', approver:'経理', canEdit: true},
          ],
          allApplications:[
            {id:'100', user:'MockUser', useDate:'2025/01/01', store:'TestStore', amount:1000, status:'承認待ち', approver:'経理', canEdit: true},
            {id:'999', user:'OtherUser', useDate:'2025/01/02', store:'Store A', amount:3000, status:'承認済', approver:'承認済', canEdit: false}
          ],
          approvalTasks:[
             {id:'1', user:'部下A', useDate:'2025/01/02', store:'StoreB', category:'消耗品', amount:2000}
          ]
        }), 500); 
      },
      
      getMasters: function() { 
        setTimeout(() => this._success && this._success({accounts: ['旅費交通費','消耗品','交際費','会議費','新聞図書費']}), 500); 
      },
      
      analyzeReceiptImage: function() { 
        setTimeout(() => this._success && this._success({
          use_date:'2025-02-01', store_name:'Mock Store', total_amount:1200, item_name:'文房具',
          category:'消耗品', has_invoice:true, summary_text:'[AI読取]\n日付:2025/02/01\n店名:Mock Store\n金額:1200円'
        }), 1000); 
      },
      
      saveApplication: function(data) { setTimeout(() => this._success && this._success({success:true}), 1000); },
      updateApplication: function(data) { setTimeout(() => this._success && this._success({success:true}), 1000); },
      deleteApplication: function(id) { setTimeout(() => this._success && this._success({success:true}), 1000); },
      approveApplication: function() { setTimeout(() => this._success && this._success(), 500); },
      rejectApplication: function() { setTimeout(() => this._success && this._success(), 500); },
      generateCSV: function() { setTimeout(() => this._success && this._success({base64: "SGVsbG8=", filename: "mock.csv"}), 500); },
      getSpreadsheetUrl: function() { setTimeout(() => this._success && this._success("https://google.com"), 500); },
      
      predictCategoryByItem: function(item) { 
        setTimeout(() => this._success && this._success(item.includes('タクシー') ? '旅費交通費' : '消耗品'), 200); 
      },
      
      suggestItemsByCategory: function(cat) { 
        setTimeout(() => this._success && this._success(cat === '旅費交通費' ? ['タクシー代','電車代'] : ['ペン','ノート']), 200); 
      },
      
      getApplicationDetail: function(id) {
          setTimeout(() => this._success && this._success({
              id: id, appType: '営業', useDate: '2025-01-01', storeName: 'Edit Store', totalAmount: 1100,
              memo: 'Test Memo', hasInvoice: true, 
              items: [
                 { category: '消耗品', itemName: 'ペン', total_price: 110, client: '', participants: '', isAllowance: false },
                 { category: '消耗品', itemName: 'ノート', total_price: 990, client: '', participants: '', isAllowance: false }
              ]
          }), 500);
      }
    };
    window.google = { script: { run: mockRunner } };
  }

  // ==============================================
  // Main Logic
  // ==============================================
  let currentUser = null;
  let currentFileBase64 = null;
  let currentFileName = null;
  let currentMimeType = null;
  let currentEditingId = null;
  let accountMasters = []; // 勘定科目リスト

  // 初期ロード
  window.onload = function() { loadUser(); };

  // --- 共通: ユーザーロード ---
  function loadUser(manualEmail = null) {
    showLoading(true);
    google.script.run
      .withSuccessHandler(user => {
        if (user.role === 'UNREGISTERED') {
          showLoading(false);
          document.getElementById('unregisteredView').style.display = 'block';
          document.getElementById('unregisteredEmail').textContent = `ログイン中のアドレス: ${user.email}`;
          document.querySelector('nav').style.display = 'none';
          return;
        }
        currentUser = user;
        document.getElementById('userInfo').textContent = `${user.name} (${user.role})`;
        if (['課長','社長','経理'].includes(user.role)) document.getElementById('navApproval').style.display = 'block';
        if (['経理','管理者','社長'].includes(user.role)) document.getElementById('navAdmin').style.display = 'block';
        
        showView('apply');
        loadMasters();
        showLoading(false);
      })
      .withFailureHandler(err => {
        document.getElementById('dashboardView').style.display = 'none';
        document.getElementById('loginView').style.display = 'block';
        showLoading(false);
      })
      .getCurrentUser(manualEmail);
  }

  function manualLogin() {
    const email = document.getElementById('inputEmail').value;
    if(email) {
      document.getElementById('loginView').style.display = 'none';
      loadUser(email);
    }
  }

  // --- 画面切り替え ---
  function showView(viewId) {
    ['dashboardView','applyView','approvalListView','adminView','unregisteredView'].forEach(id => document.getElementById(id).style.display = 'none');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    
    const navMap = {dashboard:'nav-dashboard', apply:'nav-apply', approvalList:'nav-approvalList', admin:'nav-admin'};
    if(navMap[viewId]) document.getElementById(navMap[viewId]).classList.add('active');

    document.getElementById(viewId + 'View').style.display = 'block';
    
    if (viewId === 'dashboard') loadDashboard();
    if (viewId === 'admin') google.script.run.withSuccessHandler(url => document.getElementById('spreadsheetLink').href = url).getSpreadsheetUrl();
  }

  // --- マスタロード ---
  function loadMasters() {
    google.script.run.withSuccessHandler(data => {
      accountMasters = data.accounts;
      const dl = document.getElementById('categoryList');
      dl.innerHTML = '';
      accountMasters.forEach(acc => {
         const opt = document.createElement('option');
         opt.value = acc;
         dl.appendChild(opt);
      });
    }).getMasters();
  }

  // --- ダッシュボード ---
  function loadDashboard() {
    if(!currentUser) return;
    google.script.run.withSuccessHandler(data => {
      const myTbody = document.getElementById('myAppList');
      myTbody.innerHTML = renderTableRows(data.myApplications);

      const allTabLi = document.getElementById('all-tab-li');
      const allTbody = document.getElementById('allAppList');
      
      if (currentUser.role === '経理') {
          allTabLi.style.display = 'block';
          allTbody.innerHTML = renderTableRows(data.allApplications, true);
      } else {
          allTabLi.style.display = 'none';
          allTbody.innerHTML = '';
      }

      const appTbody = document.getElementById('approvalListBody');
      document.getElementById('badgeCount').textContent = data.approvalTasks.length;
      appTbody.innerHTML = data.approvalTasks.length ? data.approvalTasks.map(task => `
        <tr><td>${task.user}</td><td>${task.useDate}</td><td>${task.store}</td>
        <td>¥${Number(task.amount).toLocaleString()}</td><td>
        <button class="btn btn-sm btn-primary" onclick="approveApp('${task.id}')">承認</button>
        <button class="btn btn-sm btn-outline-danger" onclick="rejectApp('${task.id}')">差戻し</button></td></tr>`).join('') : '<tr><td colspan="5" class="text-center">なし</td></tr>';
    }).getDashboardData(currentUser.email);
  }
  
  function renderTableRows(rows, showUser = false) {
    if (!rows || rows.length === 0) return `<tr><td colspan="${showUser ? 7 : 6}" class="text-center">なし</td></tr>`;
    return rows.map(app => `
        <tr>
          ${showUser ? `<td>${app.user}</td>` : ''}
          <td>${app.useDate}</td>
          <td>${app.store}</td>
          <td>¥${Number(app.amount).toLocaleString()}</td>
          <td><span class="badge bg-${getStatusColor(app.status)}">${app.status}</span></td>
          <td>${app.approver}</td>
          <td>
            ${app.canEdit ? `<button class="btn btn-sm btn-outline-primary" onclick="editApplication('${app.id}')">修正</button>` : '-'}
          </td>
        </tr>`).join('');
  }

  function getStatusColor(s) { return {承認済:'success',承認待ち:'warning',差戻し:'danger'}[s] || 'secondary'; }

  // --- ファイルアップロード & AI解析 ---
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  if (dropZone && fileInput) {
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#f1f1f1'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#fff'; });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#fff'; if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
  }
  document.getElementById('editFileInput').onchange = (e) => handleFile(e.target.files[0]);

  function startManualEntry() {
    currentFileBase64 = null; currentFileName = null; currentMimeType = null;
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('formArea').style.display = 'block';
    document.getElementById('previewContainer').style.display = 'none';
    document.getElementById('noImageMessage').style.display = 'block';
    if (!currentEditingId) {
       clearFormFields();
       addDetailRow(); // 1行目は空で追加
    }
  }

  function handleFile(file) {
    if (!file) return;
    currentFileName = file.name; currentMimeType = file.type;
    const reader = new FileReader();
    reader.onload = function(e) {
      currentFileBase64 = e.target.result.split(',')[1];
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('previewContainer').style.display = 'block';
      document.getElementById('noImageMessage').style.display = 'none';
      document.getElementById('uploadArea').style.display = 'none';
      document.getElementById('formArea').style.display = 'block';
      analyzeReceipt(currentFileBase64, currentMimeType);
    };
    reader.readAsDataURL(file);
  }

  function analyzeReceipt(base64, mimeType) {
    showLoading(true, 'AI解析中...');
    google.script.run.withSuccessHandler(data => {
      document.getElementById('formDate').value = data.use_date ? data.use_date.replace(/\//g, '-') : '';
      document.getElementById('formStore').value = data.store_name || '';
      document.getElementById('formTotalAmount').value = data.total_amount || 0;
      document.getElementById('checkInvoice').checked = data.has_invoice || false;
      document.getElementById('formMemo').value = data.summary_text || '';
      
      // 明細エリアクリアして1行追加
      document.getElementById('detailsBody').innerHTML = '';
      addDetailRow({
         category: data.category || '',
         itemName: data.item_name || '',
         total_price: data.total_amount || 0,
         client: data.client || '',
         participants: data.participants || ''
      });
      calcTableTotal();

      // カテゴリ推測補完 (AIが返していない場合)
      if (!data.category && data.item_name) {
         google.script.run.withSuccessHandler(cat => {
            if(cat) {
               const firstRowCat = document.querySelector('.detail-cat');
               if(firstRowCat && !firstRowCat.value) firstRowCat.value = cat;
            }
         }).predictCategoryByItem(data.item_name);
      }
      showLoading(false);
    }).withFailureHandler(err => {
      alert('解析エラー: ' + err.message);
      showLoading(false);
    }).analyzeReceiptImage(base64, mimeType);
  }

  // --- 明細テーブル制御 ---
  function addDetailRow(data = null) {
     const tbody = document.getElementById('detailsBody');
     const tr = document.createElement('tr');
     tr.className = 'detail-row';
     tr.innerHTML = `
        <td>
           <input type="text" class="form-control form-control-sm detail-cat" list="categoryList" value="${data ? data.category : ''}" placeholder="科目">
        </td>
        <td>
           <input type="text" class="form-control form-control-sm detail-item" value="${data ? data.itemName : ''}" placeholder="品代など">
        </td>
        <td>
           <input type="number" class="form-control form-control-sm detail-price" value="${data ? data.total_price : ''}" oninput="calcTableTotal()">
        </td>
        <td>
           <input type="text" class="form-control form-control-sm detail-client" value="${data ? data.client : ''}">
        </td>
        <td>
           <input type="number" class="form-control form-control-sm detail-people" value="${data ? data.participants : ''}">
        </td>
        <td class="text-center">
           <input type="checkbox" class="form-check-input detail-allowance" ${data && data.isAllowance ? 'checked' : ''}>
        </td>
        <td class="text-center">
           <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDetailRow(this)"><i class="fas fa-times"></i></button>
        </td>
     `;
     tbody.appendChild(tr);
     calcTableTotal();
  }

  function removeDetailRow(btn) {
     const tbody = document.getElementById('detailsBody');
     if(tbody.children.length > 1) {
        btn.closest('tr').remove();
        calcTableTotal();
     } else {
        alert('明細は最低1行必要です');
     }
  }

  function calcTableTotal() {
     let sum = 0;
     document.querySelectorAll('.detail-price').forEach(input => {
        sum += Number(input.value) || 0;
     });
     document.getElementById('calcTotal').textContent = sum.toLocaleString();
     
     // 領収書合計と比較
     const headerTotal = Number(document.getElementById('formTotalAmount').value) || 0;
     const alertEl = document.getElementById('amountAlert');
     if (headerTotal !== 0 && headerTotal !== sum) {
        alertEl.style.display = 'inline';
     } else {
        alertEl.style.display = 'none';
     }
  }
  
  document.getElementById('formTotalAmount').addEventListener('input', calcTableTotal);

  // --- 修正機能 ---
  function editApplication(id) {
    showLoading(true, 'データ取得中...');
    google.script.run.withSuccessHandler(data => {
        currentEditingId = id;
        document.getElementById('applyViewTitle').textContent = '申請内容の修正・分解';
        document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-sync-alt me-2"></i>修正する';
        document.getElementById('btnDelete').style.display = 'block';
        
        showView('apply');
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('formArea').style.display = 'block';
        
        document.getElementById('previewContainer').style.display = 'none'; 
        document.getElementById('noImageMessage').style.display = 'block';
        document.getElementById('noImageMessage').textContent = '登録済みの画像は保持されます';
        document.getElementById('editImageUpload').style.display = 'block';

        // ヘッダーセット
        document.getElementById('formDate').value = data.useDate;
        document.getElementById('formStore').value = data.storeName;
        document.getElementById('formTotalAmount').value = data.totalAmount;
        document.getElementById('checkInvoice').checked = data.hasInvoice;
        document.getElementById('formMemo').value = data.memo;
        
        const radio = document.querySelector(`input[name="appType"][value="${data.appType}"]`);
        if(radio) radio.checked = true;

        // 明細セット
        document.getElementById('detailsBody').innerHTML = '';
        if (data.items && data.items.length > 0) {
            data.items.forEach(item => addDetailRow(item));
        } else {
            addDetailRow();
        }

        showLoading(false);
    }).withFailureHandler(err => {
        alert('エラー: ' + err.message);
        showLoading(false);
    }).getApplicationDetail(id);
  }

  // --- 申請送信 ---
  function submitApplication() {
    // バリデーション
    if(!document.getElementById('formDate').value) return alert('利用日を入力してください');
    if(!document.getElementById('formStore').value) return alert('支払先を入力してください');
    if(!document.getElementById('formTotalAmount').value) return alert('合計金額を入力してください');
    
    const appTypeEl = document.querySelector('input[name="appType"]:checked');
    if (!appTypeEl) return alert('申請区分（営業/個人）を選択してください');

    // 金額チェック
    const headerTotal = Number(document.getElementById('formTotalAmount').value);
    let detailTotal = 0;
    const items = [];
    let hasError = false;

    document.querySelectorAll('.detail-row').forEach(tr => {
       const cat = tr.querySelector('.detail-cat').value;
       const name = tr.querySelector('.detail-item').value;
       const price = Number(tr.querySelector('.detail-price').value);
       
       if (!name || price === 0) hasError = true;

       detailTotal += price;
       items.push({
          category: cat,
          itemName: name,
          total_price: price,
          client: tr.querySelector('.detail-client').value,
          participants: tr.querySelector('.detail-people').value,
          isAllowance: tr.querySelector('.detail-allowance').checked
       });
    });

    if (hasError) return alert('明細の項目名と金額は必須です');
    if (headerTotal !== detailTotal) {
       if(!confirm(`領収書合計(${headerTotal}円)と明細合計(${detailTotal}円)が一致しませんが、このまま申請しますか？\n(通常は一致させる必要があります)`)) return;
    }

    const actionName = currentEditingId ? '修正' : '申請';
    if(!confirm(`${actionName}しますか？`)) return;
    
    showLoading(true, '送信中...');

    const formData = {
      id: currentEditingId || null, 
      appType: appTypeEl.value,
      useDate: document.getElementById('formDate').value,
      userName: currentUser.name,
      storeName: document.getElementById('formStore').value,
      totalAmount: headerTotal,
      memo: document.getElementById('formMemo').value,
      fileName: currentFileName || '', fileBase64: currentFileBase64, mimeType: currentMimeType,
      hasInvoice: document.getElementById('checkInvoice').checked,
      items: items // 明細配列
    };

    const run = google.script.run.withSuccessHandler(res => {
        alert(currentEditingId ? '修正完了しました' : '申請完了');
        showLoading(false);
        resetApplyForm(); 
        showView('dashboard');
    }).withFailureHandler(err => {
        alert('エラー: ' + err.message);
        showLoading(false);
    });

    if (currentEditingId) {
        run.updateApplication(formData);
    } else {
        run.saveApplication(formData, items);
    }
  }

  // --- 削除 ---
  function deleteCurrentApp() {
    if (!currentEditingId) return;
    if (!confirm('本当にこの申請を削除しますか？\n（この操作は取り消せません）')) return;

    showLoading(true, '削除中...');
    google.script.run.withSuccessHandler(res => {
        alert('削除しました');
        showLoading(false);
        resetApplyForm();
        showView('dashboard');
    }).withFailureHandler(err => {
        alert('削除エラー: ' + err.message);
        showLoading(false);
    }).deleteApplication(currentEditingId);
  }

  // --- フォームリセット ---
  function clearFormFields() {
    ['formDate','formStore','formTotalAmount','formMemo'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('checkInvoice').checked = false;
    document.querySelectorAll('input[name="appType"]').forEach(el => el.checked = false);
    document.getElementById('editFileInput').value = '';
    document.getElementById('detailsBody').innerHTML = ''; // 明細クリア
    document.getElementById('calcTotal').textContent = '0';
    document.getElementById('amountAlert').style.display = 'none';
  }

  function resetApplyForm() {
    currentEditingId = null;
    currentFileBase64 = null; currentFileName = null;
    document.getElementById('applyViewTitle').textContent = '経費申請';
    document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-paper-plane me-2"></i>申請する';
    document.getElementById('btnDelete').style.display = 'none';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('formArea').style.display = 'none';
    document.getElementById('editImageUpload').style.display = 'none';
    document.getElementById('noImageMessage').textContent = '領収書画像なし\n(手入力モード)';
    document.getElementById('fileInput').value = '';
    clearFormFields();
  }
  
  function approveApp(id) { if(confirm('承認しますか？')) google.script.run.withSuccessHandler(() => { alert('承認しました'); loadDashboard(); }).approveApplication(id, currentUser.email); }
  function rejectApp(id) { const reason = prompt('差戻し理由'); if(reason) google.script.run.withSuccessHandler(() => { alert('差戻しました'); loadDashboard(); }).rejectApplication(id, reason); }
  function downloadCSV(type) {
    showLoading(true, 'CSV作成中...');
    google.script.run.withSuccessHandler(res => {
      const bin = atob(res.base64); const arr = new Uint8Array(bin.length);
      for(let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([arr], {type:'text/csv;charset=' + (res.charset || 'Shift_JIS')}));
      a.download = res.filename; a.click(); showLoading(false);
    }).withFailureHandler(err => { alert('エラー: ' + err.message); showLoading(false); }).generateCSV(type);
  }
  function showLoading(show, text='処理中...') { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; document.getElementById('loadingText').textContent = text; }
</script>
</body>
</html>

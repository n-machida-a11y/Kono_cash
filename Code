/**
 * 現金経費精算アプリ - サーバーサイドスクリプト
 * v17.0: 管理者用一括操作・仕訳CSV出力機能強化
 */

// 定数定義：シート名
const SHEETS = {
  RECEIPTS: '領収書',
  DETAILS: '明細',
  ACCOUNTS: '勘定科目マスタ',
  USERS: '使用者マスタ',
  LEARNING: '学習データ',
  RULES: '承認ルール設定',
  CSV_CONFIG: 'CSV出力設定'
};

// ステータス定数
const STATUS = {
  DRAFT: '未申請',
  PENDING: '承認待ち',
  APPROVED: '承認済',
  REJECTED: '差戻し',
  CHECKED: '確認済み',      // 追加: 経理チェック済
  EXPORTED: 'CSV出力済み'  // 追加: 完了
};

// 領収書シートの列インデックス (0始まり)
const R_COLS = {
  ID: 0, DATE: 1, APP_TYPE: 2, USE_DATE: 3, USER: 4, STORE: 5, AMOUNT: 6, MEMO: 7, STATUS: 11, APPROVER: 12
};

// APIキー・フォルダ設定
const GEMINI_API_KEY = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY') || '';
const RECEIPT_FOLDER_ID = PropertiesService.getScriptProperties().getProperty('RECEIPT_FOLDER_ID') || '';

function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('現金経費精算アプリ')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/**
 * 初期セットアップ
 */
function setupSpreadsheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const headers = {
    [SHEETS.RECEIPTS]: ['登録ID', '登録日時', '申請区分', '利用日', '使用者', '支払先', '合計金額', 'メモ', 'ファイル名', 'ファイルID', 'インボイス有無', 'ステータス', '現在の承認者'],
    [SHEETS.DETAILS]: ['明細ID', '親登録ID', '勘定科目', '項目名', '日当・宿泊', '取引先', '参加人数', '金額(税込)', '税抜', '消費税', 'メモ'],
    [SHEETS.ACCOUNTS]: ['科目名', '科目コード'],
    [SHEETS.USERS]: ['氏名', 'メールアドレス', '権限', '銀行コード', '修正可否', '役職', '部門コード'],
    [SHEETS.LEARNING]: ['キーワード', '正解勘定科目', '登録回数', '種別'], 
    [SHEETS.RULES]: ['ルールID', '優先順位', '対象科目', '金額条件', 'キーワード条件', '日当条件', '必須承認者ルート'],
    [SHEETS.CSV_CONFIG]: ['出力種別', '列順', 'ヘッダー名', '参照元', 'カラム名', 'フォーマット指定', '文字コード']
  };

  for (const [sheetName, headerRow] of Object.entries(headers)) {
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      sheet.appendRow(headerRow);
      sheet.setFrozenRows(1);
      sheet.getRange(1, 1, 1, headerRow.length).setFontWeight('bold');
    }
  }
}

// --- ヘッダー配列から列マップを生成 ---
function createColumnMap(headerRow) {
  const map = {};
  if (!headerRow) return map;
  headerRow.forEach((h, i) => map[String(h).trim()] = i);
  return map;
}

// --- ユーザー認証 ---
function getCurrentUser(manualEmail = null) {
  const email = manualEmail || Session.getActiveUser().getEmail();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.USERS);
  const data = sheet.getDataRange().getValues();
  const colMap = createColumnMap(data[0]);

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][colMap['メールアドレス']]).trim().toLowerCase() === String(email).trim().toLowerCase()) {
      return {
        name: data[i][colMap['氏名']],
        email: data[i][colMap['メールアドレス']],
        role: data[i][colMap['権限']],
        position: data[i][colMap['役職']] || '',
        canFix: String(data[i][colMap['修正可否']]).trim() === '可'
      };
    }
  }
  return { name: '', email: email, role: 'ゲスト', position: '', canFix: true };
}

function getSpreadsheetUrl() { return SpreadsheetApp.getActiveSpreadsheet().getUrl(); }

// --- ダッシュボードデータ取得 ---
function getDashboardData(userEmail) {
  const user = getCurrentUser(userEmail);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const rSheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const dSheet = ss.getSheetByName(SHEETS.DETAILS);
  const result = { user: user, myApplications: [], approvalTasks: [], allApplications: [] };

  if (rSheet.getLastRow() <= 1) return result;

  const rData = rSheet.getDataRange().getValues();
  const rColMap = createColumnMap(rData[0]);
  const dData = dSheet.getDataRange().getValues();
  const dColMap = createColumnMap(dData[0]);

  // 明細情報の紐付け準備
  const detailMap = {};
  for(let i=1; i<dData.length; i++){
    const pid = String(dData[i][dColMap['親登録ID']]);
    if(!detailMap[pid]) detailMap[pid] = [];
    detailMap[pid].push({ category: dData[i][dColMap['勘定科目']] });
  }

  rData.slice(1).forEach((row) => {
    const formatDate = (d) => d instanceof Date ? Utilities.formatDate(d, Session.getScriptTimeZone(), 'yyyy/MM/dd') : String(d);
    const id = String(row[rColMap['登録ID']]);
    const status = row[rColMap['ステータス']];
    const rowUser = String(row[rColMap['使用者']]);

    const item = {
      id: id,
      date: formatDate(row[rColMap['登録日時']]),
      useDate: formatDate(row[rColMap['利用日']]),
      user: rowUser,
      store: row[rColMap['支払先']],
      amount: row[rColMap['合計金額']],
      status: status,
      approver: row[rColMap['現在の承認者']],
      category: detailMap[id] ? detailMap[id][0].category : '-',
      canEdit: (status === STATUS.DRAFT || status === STATUS.REJECTED),
      canSubmit: (status === STATUS.DRAFT)
    };

    if (rowUser === user.name) result.myApplications.push(item);
    if (item.approver === user.role && status === STATUS.PENDING) result.approvalTasks.push(item);
    if (['管理者','経理','社長'].includes(user.role)) result.allApplications.push(item);
  });

  result.myApplications.reverse();
  result.approvalTasks.reverse();
  result.allApplications.reverse();
  return result;
}

// --- 申請詳細取得 ---
function getApplicationDetail(id) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const rSheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const dSheet = ss.getSheetByName(SHEETS.DETAILS);
  const rData = rSheet.getDataRange().getValues();
  const rColMap = createColumnMap(rData[0]);

  let receipt = null;
  let fileId = null;

  for (let i = 1; i < rData.length; i++) {
    if (String(rData[i][rColMap['登録ID']]) === id) {
      fileId = rData[i][rColMap['ファイルID']];
      receipt = {
        id: id,
        appType: rData[i][rColMap['申請区分']],
        useDate: Utilities.formatDate(new Date(rData[i][rColMap['利用日']]), Session.getScriptTimeZone(), 'yyyy-MM-dd'),
        userName: rData[i][rColMap['使用者']], 
        storeName: rData[i][rColMap['支払先']],
        totalAmount: rData[i][rColMap['合計金額']],
        memo: rData[i][rColMap['メモ']],
        hasInvoice: rData[i][rColMap['インボイス有無']],
        items: []
      };
      break;
    }
  }

  if (fileId && fileId !== 'NO_FILE') {
    try {
      const file = DriveApp.getFileById(fileId);
      receipt.fileBase64 = Utilities.base64Encode(file.getBlob().getBytes());
      receipt.mimeType = file.getBlob().getContentType();
    } catch (e) {}
  }

  const dData = dSheet.getDataRange().getValues();
  const dColMap = createColumnMap(dData[0]);
  receipt.items = dData.slice(1).filter(row => String(row[dColMap['親登録ID']]) === id).map(row => ({
    category: row[dColMap['勘定科目']],
    itemName: row[dColMap['項目名']],
    total_price: row[dColMap['金額(税込)']],
    memo: row[dColMap['メモ']]
  }));

  return receipt;
}

// --- 保存・更新系 ---
function saveApplication(formData, itemsData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const rSheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const dSheet = ss.getSheetByName(SHEETS.DETAILS);
  const regId = Utilities.getUuid();
  const now = new Date();
  
  let fileId = 'NO_FILE';
  if (formData.fileBase64) {
    const blob = Utilities.newBlob(Utilities.base64Decode(formData.fileBase64), formData.mimeType, formData.fileName);
    fileId = (RECEIPT_FOLDER_ID ? DriveApp.getFolderById(RECEIPT_FOLDER_ID) : DriveApp.getRootFolder()).createFile(blob).getId();
  }

  rSheet.appendRow([regId, now, formData.appType, formData.useDate, formData.userName, formData.storeName, formData.totalAmount, formData.memo, formData.fileName, fileId, formData.hasInvoice, STATUS.DRAFT, '-']);

  itemsData.forEach(item => {
    dSheet.appendRow([Utilities.getUuid(), regId, item.category, item.itemName, false, '', '', item.total_price, 0, 0, item.memo]);
  });
  return { success: true, id: regId };
}

function updateApplication(formData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const rSheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const dSheet = ss.getSheetByName(SHEETS.DETAILS);
  const rData = rSheet.getDataRange().getValues();
  const rColMap = createColumnMap(rData[0]);
  
  let rowIndex = -1;
  for(let i=1; i<rData.length; i++) if(String(rData[i][rColMap['登録ID']]) === formData.id) { rowIndex = i + 1; break; }
  if(rowIndex === -1) throw new Error('データなし');

  rSheet.getRange(rowIndex, rColMap['利用日'] + 1).setValue(formData.useDate);
  rSheet.getRange(rowIndex, rColMap['支払先'] + 1).setValue(formData.storeName);
  rSheet.getRange(rowIndex, rColMap['合計金額'] + 1).setValue(formData.totalAmount);
  rSheet.getRange(rowIndex, rColMap['メモ'] + 1).setValue(formData.memo);

  // 明細差し替え
  const dData = dSheet.getDataRange().getValues();
  const dColMap = createColumnMap(dData[0]);
  for(let i=dData.length-1; i>=1; i--) if(String(dData[i][dColMap['親登録ID']]) === formData.id) dSheet.deleteRow(i+1);
  formData.items.forEach(item => {
    dSheet.appendRow([Utilities.getUuid(), formData.id, item.category, item.itemName, false, '', '', item.total_price, 0, 0, item.memo]);
  });
  return { success: true };
}

// --- 管理者用アクション ---
function checkBulk(ids) { return updateStatusBulk(ids, STATUS.CHECKED); }
function markAsExported(ids) { return updateStatusBulk(ids, STATUS.EXPORTED); }

function updateStatusBulk(ids, newStatus) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const data = sheet.getDataRange().getValues();
  const idCol = createColumnMap(data[0])['登録ID'];
  const statusCol = createColumnMap(data[0])['ステータス'];

  ids.forEach(id => {
    for(let i=1; i<data.length; i++) {
      if(String(data[i][idCol]) === String(id)) {
        sheet.getRange(i+1, statusCol + 1).setValue(newStatus);
      }
    }
  });
  return { success: true };
}

/**
 * ガイドに基づくCSV出力データ作成 (仕訳形式・フラット化)
 */
function getDataForCSV(ids) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ① マスタデータのマッピング（辞書作成）
  const uSheet = ss.getSheetByName(SHEETS.USERS);
  const uData = uSheet.getDataRange().getValues();
  const userDeptMap = {};
  for(let i=1; i<uData.length; i++) userDeptMap[String(uData[i][0])] = String(uData[i][6]); // G列: 部門コード

  const aSheet = ss.getSheetByName(SHEETS.ACCOUNTS);
  const aData = aSheet.getDataRange().getValues();
  const accountCodeMap = {};
  for(let i=1; i<aData.length; i++) accountCodeMap[String(aData[i][0])] = String(aData[i][1]); // B列: 科目コード

  // ② 親子データの取得
  const rSheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const rData = rSheet.getDataRange().getValues();
  const rColMap = createColumnMap(rData[0]);
  const dSheet = ss.getSheetByName(SHEETS.DETAILS);
  const dData = dSheet.getDataRange().getValues();
  const dColMap = createColumnMap(dData[0]);

  const detailMap = {};
  for(let i=1; i<dData.length; i++){
    const pid = String(dData[i][dColMap['親登録ID']]);
    if(!detailMap[pid]) detailMap[pid] = [];
    detailMap[pid].push({ category: dData[i][dColMap['勘定科目']], item: dData[i][dColMap['項目名']], amount: dData[i][dColMap['金額(税込)']], memo: dData[i][dColMap['メモ']] });
  }

  const csvRows = [["日付", "部門コード", "借方科目コード", "借方科目名", "貸方科目コード", "貸方科目名", "支払先", "摘要", "金額(税込)"]];
  const targets = rData.filter(row => ids.includes(String(row[rColMap['登録ID']])));

  targets.forEach(row => {
    const pid = String(row[rColMap['登録ID']]);
    const useDate = row[rColMap['利用日']];
    const dateStr = (useDate instanceof Date) ? Utilities.formatDate(useDate, Session.getScriptTimeZone(), "yyyy/MM/dd") : String(useDate);
    const userName = String(row[rColMap['使用者']]);
    const storeName = String(row[rColMap['支払先']]);
    const appType = String(row[rColMap['申請区分']]);
    
    // 貸方情報の固定設定
    let creditCode = (appType === "営業所") ? "1102" : "";
    let creditName = (appType === "営業所") ? "当座預金もみじ" : "現金";

    const details = detailMap[pid] || [];
    details.forEach(d => {
      csvRows.push([
        dateStr,
        userDeptMap[userName] || "",
        accountCodeMap[d.category] || "",
        d.category,
        creditCode,
        creditName,
        storeName,
        `${d.item} ${d.memo}`.trim(),
        d.amount
      ]);
    });
  });

  return csvRows;
}

// 共通関数
function approveApplication(id) { return updateStatusBulk([id], STATUS.APPROVED); }
function rejectApplication(id, comment) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.RECEIPTS);
  const data = sheet.getDataRange().getValues();
  const rColMap = createColumnMap(data[0]);
  for(let i=1; i<data.length; i++) if(String(data[i][rColMap['登録ID']]) === id) {
    sheet.getRange(i+1, rColMap['ステータス']+1).setValue(STATUS.REJECTED);
    sheet.getRange(i+1, rColMap['メモ']+1).setValue(data[i][rColMap['メモ']] + "\n[差戻し理由] " + comment);
  }
}
function uploadAndAnalyzeAndDraft(data) { return saveApplication(data, [{category:'', itemName:'解析中', total_price:0, memo:''}]); }
function getMasters() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const accounts = ss.getSheetByName(SHEETS.ACCOUNTS).getDataRange().getValues().slice(1).map(r => r[0]);
  const users = ss.getSheetByName(SHEETS.USERS).getDataRange().getValues().slice(1).map(r => ({name:r[0], position:r[5]}));
  return { accounts, users };
}
